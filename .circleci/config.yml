version: 2.1

orbs:
  win: circleci/windows@2.2.0

jobs:
  Alpine:
    machine:
      image: ubuntu-1604:202007-01
    environment:
      buildConfiguration: Release
    steps:
      - checkout
      - run: docker-compose run build
      - run: docker-compose run Profiler.Alpine
      - run: docker-compose run package.alpine
      - store_artifacts:
          path: deploy/linux/

  Linux:
    machine:
      image: ubuntu-1604:202007-01
    environment:
      buildConfiguration: Release

    steps:
      - checkout
      - run: docker-compose run build
      - run: docker-compose run Profiler
      - run: docker-compose run package
      - store_artifacts:
          path: deploy/linux/

  Windows:
    executor: 
      name: win/default
      shell: cmd.exe

    steps:
      - checkout
      - run: dotnet --list-sdks
      - run: choco install wixtoolset
      - run: nuget restore Datadog.Trace.sln
      - run: msbuild Datadog.Trace.proj /t:BuildCsharp /p:Configuration=Release
      - run: dotnet pack src\Datadog.Trace\Datadog.Trace.csproj
      - run: dotnet pack src\Datadog.Trace.OpenTracing\Datadog.Trace.OpenTracing.csproj
      - run: msbuild Datadog.Trace.proj /t:BuildCpp /p:Configuration=Release;Platform=x64
      - run: msbuild Datadog.Trace.proj /t:BuildCpp /p:Configuration=Release;Platform=x86
      - run: msbuild Datadog.Trace.proj /t:msi /p:Configuration=Release;Platform=x64
      - run: msbuild Datadog.Trace.proj /t:msi /p:Configuration=Release;Platform=x86
      - run: msbuild Datadog.Trace.proj /t:CreateHomeDirectory /p:Configuration=Release;Platform=x64
      - run: nuget pack -p NoWarn=NU5100;NoBuild=true;NoDefaultExcludes=true -OutputDirectory src\bin\Azure.Site.Extension deploy\Azure.Site.Extension\Azure.Site.Extension.nuspec
      - store_artifacts:
          path: C:\Users\circleci\project\deploy\Datadog.Trace.ClrProfiler.WindowsInstaller\bin\Release\x64\en-us\
      - store_artifacts:
          path: C:\Users\circleci\project\deploy\Datadog.Trace.ClrProfiler.WindowsInstaller\bin\Release\x86\en-us\
      - store_artifacts:
          path: C:\Users\circleci\project\src\bin\windows-tracer-home.zip
      - store_artifacts:
          path: C:\Users\circleci\project\src\bin\Azure.Site.Extension\

workflows:
  version: 2
  build:
    jobs:
      - Alpine
      - Linux
      - Windows

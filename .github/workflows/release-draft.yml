name: Release draft

on:
  push:
    tags:
    - 'v*'

jobs:
  windows_build:
    name: Windows Build
    runs-on: windows-2019
    timeout-minutes: 30
    steps:
      - run: git config --system core.longpaths true
      - uses: actions/checkout@v2.4.0
      - uses: actions/setup-dotnet@v1.9.0
        with:
          dotnet-version: | 
            2.1.818
            3.1.416
            5.0.405
            6.0.200
      - run: tracer\build.cmd Clean BuildTracerHome PackageTracerHome
        shell: cmd
      - name: Upload Windows MSI
        uses: actions/upload-artifact@v2.3.1
        with:
          name: artifacts
          path: tracer/bin/artifacts/*/en-us
      - name: Upload NuGet packages
        uses: actions/upload-artifact@v2.3.1
        with:
          name: nuget
          path: tracer/bin/artifacts/nuget/SignalFx.NET.Tracing.Azure.Site.Extension.*.nupkg

  create-release:
    name: Create GH release
    runs-on: ubuntu-20.04
    needs: [ windows_build ]
    permissions:
      contents: write
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v2.4.0
      - uses: actions/download-artifact@v2.1.0
        with:
          path: .
      - name: Extract Version from Tag
        id: get_version
        run: echo ::set-output name=VERSION::${GITHUB_REF/refs\/tags\/v}
      - name: Create Release
        run: gh release create v${{ steps.get_version.outputs.VERSION }} --draft artifacts/signalfx* artifacts/x64/en-us/*.msi  artifacts/x86/en-us/*.msi nuget/SignalFx.NET.Tracing.Azure.Site.Extension.*.nupkg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

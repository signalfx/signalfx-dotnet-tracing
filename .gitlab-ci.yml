workflow:
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v/'

stages:
  - build
  - verify

linux-build:
  stage: build
  parallel:
    matrix:
      - baseImage: [ alpine, debian ]
  variables:
    dotnetSdkVersion: 6.0.200
  script:
    - |
      rm .dockerignore
    - |
      docker build \
        --build-arg DOTNETSDK_VERSION=${dotnetSdkVersion} \
        --tag dd-trace-dotnet/${baseImage}-builder \
        --target releaser \
        --file "./tracer/build/_build/docker/${baseImage}.dockerfile" \
        .
    - |
      docker run \
        --env NugetPackageDirectory=/project/packages \
        --env tracerHome=/project/tracer/bin/tracer-home \
        --env artifacts=/project/tracer/src/bin/artifacts \
        --name release \
        dd-trace-dotnet/${baseImage}-builder \
        tracer/build.sh Clean BuildTracerHome ZipTracerHome
    - |
      docker cp release:/project/tracer/src/bin/artifacts/linux-x64 dist
  artifacts:
    paths:
      - dist/

# windows-build:
#   stage: build
#   tags:
#     - windows
#   script:
#     - tracer\build.ps1 Clean BuildTracerHome PackageTracerHome
#   artifacts:
#     paths:
#       - tracer/bin/artifacts/nuget/SignalFx.NET.Tracing.Azure.Site.Extension.*.nupkg
#       - tracer/bin/artifacts/*/en-us

verify-artifacts:
  stage: verify
  before_script:
    - apt-get update && apt-get install -y --fix-missing curl unzip
  script:
    - mkdir -p /project/tracer/bin/artifacts/temp
    - cd /project/tracer/bin/artifacts/temp
    - 'curl --location --output artifacts.zip "https://cd.splunkdev.com/o11y-gdi/dotnet-maintainers/signalfx-dotnet-tracing-releaser/-/jobs/$CI_JOB_ID/artifacts/download?job_token=$CI_JOB_TOKEN"'
    - unzip artifacts.zip
    - mv -v ./dist/* ./../
    - cd /project
    - rm -rd /project/tracer/bin/artifacts/temp
    - tracer/build.sh ChecksumArtifacts --artifacts /project/tracer/bin/artifacts
  artifacts:
    paths:
      - tracer/bin/artifacts/checksums.txt
    